@using CNP.Segreteria.Models
@implements IDisposable

<style>
    .griglia-scroll-container {
        width: 100%;
        height: var(--altezza-griglia, 490px);
        overflow: auto;
        border: 1px solid #dee2e6;
        background: white;
        display: block;
    }

    .tabella-imbarcazioni {
        min-width: 2000px;
        width: 100%;
        margin: 0;
        border-collapse: collapse;
    }

        .tabella-imbarcazioni thead th {
            background-color: var(--cnf-blu-scuro);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 12px 8px;
            border: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .tabella-imbarcazioni tbody td {
            padding: 8px;
            border: 1px solid #dee2e6;
            white-space: nowrap;
            vertical-align: middle;
        }

        .tabella-imbarcazioni tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }

    /* HEADER RICERCA - PER TUTTE LE ANAGRAFICHE */
    .header-ricerca {
        flex: 1;
        max-width: 400px;
        margin-right: 1rem;
    }

    .card-header-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .counter-badge {
        background-color: var(--cnf-blu-medio);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* EVIDENZIAZIONE TEMPORANEA - VERDE MOLTO VIVIDO */
    .riga-evidenziata {
        background-color: #c3e6cb !important;
        border-left: 5px solid #218838;
        box-shadow: 0 0 12px rgba(33, 136, 56, 0.4);
        transition: all 0.3s ease-in-out;
    }

        .riga-evidenziata td {
            font-weight: 700;
            color: #0f5132;
        }
</style>

<!-- GRIGLIA FILTRATA -->
@if (Imbarcazioni == null || !Imbarcazioni.Any())
{
    <div class="alert alert-warning">
        Nessuna imbarcazione trovata nel database.
    </div>
}
else if (imbarcazioniFiltrate.Count == 0 && !string.IsNullOrEmpty(testoRicerca))
{
    <div class="alert alert-info">
        Nessuna imbarcazione trovata per "<strong>@testoRicerca</strong>"
    </div>
}
else
{
    <div class="griglia-scroll-container" style="--altezza-griglia: @AltezzaGriglia;">
        <table class="tabella-imbarcazioni table-striped">
            <thead>
                <tr>
                    <th>Azioni</th>
                    <th>ID</th>
                    <th>Nome Imbarcazione</th>
                    <th>Tipo Imbarcazione</th>
                    <th>Codice Cliente</th>  <!-- ⚠️ NUOVA COLONNA -->
                    <th>Cliente</th>
                    <th>Anno Costruzione</th>
                    <th>Lunghezza</th>
                    <th>Larghezza</th>
                    <th>Pescaggio FB</th>
                    <th>Pescaggio EB</th>
                    <th>Peso</th>
                    <th>Materiale Scafo</th>
                    <th>Data Acquisto</th>
                    <th>Stato</th>
                    <th>Porto Attracco</th>
                    <th>Note</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var imbarcazione in imbarcazioniFiltrate)
                {
                    <tr class="@(imbarcazione == ImbarcazioneEvidenziata ? "riga-evidenziata" : "")">
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" @onclick="() => OnModificaImbarcazione.InvokeAsync(imbarcazione)">
                                    ✏️
                                </button>
                                <button class="btn btn-outline-danger" @onclick="() => OnEliminaImbarcazione.InvokeAsync(imbarcazione)">
                                    🗑️
                                </button>
                            </div>
                        </td>
                        <td><strong>@imbarcazione.ID_Imbarcazione</strong></td>
                        <td>@imbarcazione.Nome_Imbarcazione</td>
                        <td>@imbarcazione.Nome_Tipo</td>
                        <td>@imbarcazione.CodiceCliente</td> 
                        <td>@imbarcazione.RagioneSociale_Cliente</td>
                        <td>@imbarcazione.Anno_Costruzione</td>
                        <td>@imbarcazione.Lunghezza</td>
                        <td>@imbarcazione.Larghezza</td>
                        <td>@imbarcazione.Pescaggio_FB</td>
                        <td>@imbarcazione.Pescaggio_EB</td>
                        <td>@imbarcazione.Peso</td>
                        <td>@imbarcazione.Materiale_Scafo</td>
                        <td>@imbarcazione.Data_Acquisto?.ToString("dd/MM/yyyy")</td>
                        <td>@imbarcazione.Stato</td>
                        <td>@imbarcazione.PortoAttracco</td>
                        <td>@imbarcazione.Note</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    [Parameter]
    public List<Imbarcazione>? Imbarcazioni { get; set; }

    [Parameter]
    public EventCallback<Imbarcazione> OnModificaImbarcazione { get; set; }

    [Parameter]
    public EventCallback<Imbarcazione> OnEliminaImbarcazione { get; set; }

    [Parameter]
    public string AltezzaGriglia { get; set; } = "490px";

    [Parameter]
    public Imbarcazione? ImbarcazioneEvidenziata { get; set; }

    private string testoRicerca = string.Empty;
    private List<Imbarcazione> imbarcazioniFiltrate = new();

    protected override void OnParametersSet()
    {
        FiltraImbarcazioni();
    }

    private void FiltraImbarcazioni()
    {
        if (Imbarcazioni == null)
        {
            imbarcazioniFiltrate = new List<Imbarcazione>();
            return;
        }

        if (string.IsNullOrWhiteSpace(testoRicerca))
        {
            imbarcazioniFiltrate = Imbarcazioni;
            return;
        }

        var termine = testoRicerca.Trim().ToLower();
        imbarcazioniFiltrate = Imbarcazioni.Where(i =>
            (i.Nome_Imbarcazione?.ToLower().Contains(termine) == true) ||
            (i.Materiale_Scafo?.ToLower().Contains(termine) == true) ||
            (i.Stato?.ToLower().Contains(termine) == true) ||
            (i.PortoAttracco?.ToLower().Contains(termine) == true)
        ).ToList();
    }

    public void Dispose()
    {
        // Cleanup se necessario
    }
}
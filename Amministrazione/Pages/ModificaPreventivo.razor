@page "/amministrazione/modifica-preventivo/{PreventivoId:int}"

//<link href="css/Amministrazione/NuovoPreventivo.css" rel="stylesheet" />
<link href="css/Amministrazione/NuovoPreventivo.css?v=1.1" rel="stylesheet" />

@using CNP.Segreteria.Models
@using CNP.SchedaLavorazione.Models
@using CNP.Amministrazione.Models
@using CNP.Amministrazione.Services
@using System.Globalization;
@using Microsoft.Data.SqlClient;
@using System.Data;
@inject NavigationManager Navigation
@inject PreventiviService PreventiviService
@inject ModelliPreventiviService ModelliPreventiviService
@inject ClientiService ClientiService
@inject ImbarcazioniService ImbarcazioniService
@inject AttivitaService AttivitaService
@inject SubAttivitaService SubAttivitaService
@inject CalcoloService CalcoloService
@inject MaterialiService MaterialiService
@inject UnitaMisuraService UnitaMisuraService
@inject DettaglioPreventiviService DettaglioPreventiviService
@inject SchedaLavorazioneService SchedaLavorazioneService
@inject EmailService EmailService
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime

<PageTitle>Cantiere Navale - Modifica Preventivo</PageTitle>

<style>

    /* HEADER COMPATTO */
    .page-header-compact {
        padding: 15px 0;
        margin-bottom: 20px;
        border-bottom: 2px solid #2c3e50;
    }

        .page-header-compact h1 {
            font-size: 1.5rem; /* MODIFICA QUESTA DIMENSIONE */
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        /* Se vuoi un font più piccolo, usa: */
        .page-header-compact h1 {
            font-size: 1.2rem; /* PIÙ PICCOLO */
            font-weight: 500; /* MENO GRASSETTO */
        }

    .table-compact thead th {
        background-color: #2c3e50 !important;
        color: white !important;
    }

    .dati-compatti {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .riga-compatta {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        align-items: center;
    }

    .campo {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }

        .campo.larga {
            flex: 2;
        }

        .campo label {
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
            margin: 0;
        }

        .campo .valore {
            padding: 6px 10px;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            flex: 1;
        }

        .campo input,
        .campo select,
        .campo textarea {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            flex: 1;
        }

        .campo textarea {
            resize: vertical;
            min-height: 60px;
        }

    /* SE NON ESISTE GIÀ, AGGIUNGI: */
    .btn-small {
        padding: 6px 12px;
        font-size: 0.9rem;
        display: inline-block;
        width: auto;
        margin: 0 5px;
    }

    .footer-actions {
        display: flex;
        flex-direction: row;
        gap: 15px;
        align-items: center;
    }

        .footer-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            white-space: nowrap;
        }
</style>


@if (preventivoNonTrovato)
{
    <div class="alert alert-danger">
        <h4>❌ Preventivo non trovato</h4>
        <p>Il preventivo con ID @PreventivoId non esiste o non è accessibile.</p>
        <button class="btn btn-secondary" @onclick="Annulla">Torna alla Lista</button>
    </div>
}
else
{
    <!-- HEADER -->
    <div class="page-header-compact">
        <h1>Modifica Preventivo #@PreventivoId</h1>
    </div>

    <!-- DATI PREVENTIVO COMPATTI -->
    <div class="dati-compatti">
        <!-- RIGA 1: NUMERO E DATE -->
        <div class="riga-compatta">
            <div class="campo">
                <label>Preventivo #</label>
                <span class="valore">@preventivo.PreventivoId</span>
            </div>
            <div class="campo">
                <label>Data Emissione:</label>
                <input @bind="preventivo.DataCreazione" type="date" @bind:format="yyyy-MM-dd" />
            </div>
            <div class="campo">
                <label>Data Scadenza:</label>
                <input @bind="dataScadenza" type="date" @bind:format="yyyy-MM-dd" />
            </div>
        </div>

        <!-- RIGA 2: CLIENTE E BARCA -->
        <div class="riga-compatta">
            <div class="campo">
                <label>Cliente:</label>
                <span class="valore">@preventivo.RagioneSociale</span>
            </div>
            <div class="campo">
                <label>Imbarcazione:</label>
                <span class="valore">@preventivo.NomeBarca</span>
            </div>
        </div>

        <!-- RIGA 3: DESCRIZIONE -->
        <div class="riga-compatta">
            <div class="campo larga">
                <label>Titolo:</label>
                <textarea @bind="preventivo.Descrizione" rows="2"></textarea>
            </div>
        </div>

        <!-- RIGA 4: FILE E STATO -->
        <div class="riga-compatta">
            <div class="campo">
                <label>File:</label>
                <input @bind="preventivo.NomePreventivo" />
            </div>
            <div class="campo">
                <label>Stato:</label>
                <select @bind="preventivo.Stato">
                    <option value="">-- Seleziona Stato --</option>
                    <option value="BOZZA">BOZZA</option>
                    <option value="INVIATO">INVIATO</option>
                    <option value="ACCETTATO">ACCETTATO</option>
                    <option value="IN LAVORAZIONE">IN LAVORAZIONE</option>
                    <option value="RIFIUTATO">RIFIUTATO</option>
                    <option value="IN REVISIONE">IN REVISIONE</option>
                    <option value="SCADUTO">SCADUTO</option>
                    <option value="CONVERTITO IN ORDINE">CONVERTITO IN ORDINE</option>
                    <option value="ANNULLATO">ANNULLATO</option>
                    <option value="IN ATTESA DI PAGAMENTO">IN ATTESA DI PAGAMENTO</option>
                </select>
            </div>
        </div>
    </div>

    <!-- CORPO PREVENTIVO -->
    <div class="sezione-corpo">
        <div class="header-corpo-preventivo">
            <h3>🔧 Corpo Preventivo</h3>
        </div>

        <div class="griglia-compact">
            <table class="table table-bordered table-compact">
                <thead>
                    <tr>
                        <th width="80">Azioni</th>
                        <th width="50">#</th>
                        <th width="180" style="min-width: 160px;">ATTIVITÀ</th>
                        <th width="180" style="min-width: 150px;">VOCE</th>
                        <th width="70">N.<br>OPERAI</th>
                        <th width="120">U.M.<br>VOCE</th>
                        <th width="70">Q.TA'<br>UM</th>
                        <th width="80">IMPORTO<br>VOCE</th>
                        <th width="200">CODICE MATERIALE</th>
                        <th width="120">U.M.<br>MAT</th>
                        <th width="70">Q.TA'<br>UM</th>
                        <th width="70">COSTO<br>MATERIALE</th>
                        <th width="70">IMPORTO<br>MATER.</th>
                        <th width="80">TOTALE VOCE</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!vociPreventivo.Any())
                    {
                        <tr>
                            <td colspan="14" class="text-center text-muted">
                                Nessuna voce nel preventivo.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var (voce, index) in vociPreventivo.Select((v, i) => (v, i)))
                        {
                            var isInEditing = voce.Id == idRigaInEditing;
                            <tr class="@(index % 2 == 0 ? "tr-even" : "tr-odd") @(isInEditing ? "riga-editing" : "") tr-hover">
                                
                                <!-- AZIONI IN PRIMA COLONNA -->
                                <td>
                                    <div class="btn-group-azioni">
                                        @if (StatoRigaCorrente(voce) == StatoRiga.Editing)
                                        {
                                            <button class="btn-icon" @onclick="() => ConfermaModifiche(voce)" title="Conferma">✅</button>
                                            <button class="btn-icon" @onclick="() => AnnullaModifiche(voce)" title="Annulla">❌</button>
                                        }
                                        else if (StatoRigaCorrente(voce) == StatoRiga.Visualizzazione)
                                        {
                                            <button class="btn-icon" @onclick="() => AttivaEditing(voce)" title="Modifica">✏️</button>
                                            <button class="btn-icon" @onclick="() => EliminaVoce(voce)" title="Elimina">🗑️</button>
                                            <button class="btn-icon" @onclick="() => AggiungiVoceAttivita(voce)" title="Aggiungi voce">➕</button>
                                        }
                                        else
                                        {
                                            <button class="btn-icon" @onclick="() => EliminaVoce(voce)" title="Elimina">🗑️</button>
                                        }
                                    </div>
                                </td>

                                <td>@(voce.Id > 0 ? voce.Id.ToString() : "new")</td>

                                <!-- COLONNA ATTIVITÀ -->
                                <td class="td-attivita">
                                    @if (StatoRigaCorrente(voce) == StatoRiga.Vuota)
                                    {
                                        <select @onchange="(e) => OnAttivitaSelezionata(e, voce)" class="combo-inline">
                                            <option value="">-- Seleziona Attività --</option>
                                            @foreach (var attivita in listaAttivita)
                                            {
                                                <option value="@attivita.NomeAttivita">@attivita.NomeAttivita</option>
                                            }
                                        </select>
                                    }
                                    else
                                    {
                                        @voce.DescrizioneAttivita
                                    }
                                </td>

                                <!-- COLONNA VOCE -->
                                <td class="td-attivita">
                                    @if (StatoRigaCorrente(voce) == StatoRiga.AttivitaSelezionata)
                                    {
                                        <select @onchange="(e) => OnVoceSelezionata(e, voce)" class="combo-inline">
                                            <option value="">-- Seleziona Voce --</option>
                                            @foreach (var subAttivita in subAttivitaPerCombo)
                                            {
                                                var isDuplicato = IsVoceGiaPresente(voce.DescrizioneAttivita, subAttivita.Voce);
                                                @if (isDuplicato)
                                                {
                                                    <option value="" disabled class="option-duplicato">
                                                        @subAttivita.Voce 🔴
                                                    </option>
                                                }
                                                else
                                                {
                                                    <option value="@subAttivita.ID" class="option-disponibile">
                                                        @subAttivita.Voce
                                                    </option>
                                                }
                                            }
                                        </select>
                                    }
                                    else if (StatoRigaCorrente(voce) == StatoRiga.Vuota)
                                    {
                                        <span class="text-muted small">Seleziona attività</span>
                                    }
                                    else
                                    {
                                        @voce.DescrizioneVoce
                                    }
                                </td>

                                <!-- N. OPERAI -->
                                <td class="td-attivita text-center">
                                    @if (StatoRigaCorrente(voce) == StatoRiga.Editing && campiEditabili.Contains("N_Operatori"))
                                    {
                                        <input value="@voce.N_Operatori"
                                               @oninput="@((e) => OnCampoModificato(e, voce, "N_Operatori"))"
                                               class="campo-editabile" />
                                    }
                                    else if (StatoRigaCorrente(voce) >= StatoRiga.Visualizzazione)
                                    {
                                        @voce.N_Operatori
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- U.M. VOCE -->
                                <td class="td-attivita text-center">
                                    @if (StatoRigaCorrente(voce) == StatoRiga.Editing && campiEditabili.Contains("UnitaMisura"))
                                    {
                                        <select value="@voce.UnitaMisura"
                                                @onchange="@((e) => OnCampoModificato(e, voce, "UnitaMisura"))"
                                                class="campo-editabile combo-unita-misura">
                                            <option value="">-- Seleziona U.M. --</option>
                                            @foreach (var um in unitaMisuraAttivita)
                                            {
                                                <option value="@um.UM">@um.UM - @um.Descrizione</option>
                                            }
                                        </select>
                                    }
                                    else if (StatoRigaCorrente(voce) >= StatoRiga.Visualizzazione)
                                    {
                                        @voce.UnitaMisura
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- Q.TA' UM ATTIVITÀ -->
                                <td class="td-attivita text-end">
                                    @if (StatoRigaCorrente(voce) == StatoRiga.Editing && campiEditabili.Contains("Qta_Voce"))
                                    {
                                        <input value="@voce.Qta_Voce"
                                               @oninput="@((e) => OnCampoModificato(e, voce, "Qta_Voce"))"
                                               class="campo-editabile" />
                                    }
                                    else if (StatoRigaCorrente(voce) >= StatoRiga.Visualizzazione)
                                    {
                                        @FormattaNumero(voce.Qta_Voce) <!-- MODIFICA QUI -->
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- IMPORTO VOCE (calcolato, sola lettura) -->
                                <td class="td-attivita text-end">@voce.ImportoVoce.ToString("N1") €</td>

                                <!-- CODICE MATERIALE -->
                                <td class="td-materiali">
                                    @if (StatoRigaCorrente(voce) == StatoRiga.Editing && campiEditabili.Contains("CodiceMateriale"))
                                    {
                                        <select @onchange="@((e) => OnCampoModificato(e, voce, "CodiceMateriale"))"
                                                class="campo-editabile">
                                            <option value="">-- Seleziona Materiale --</option>
                                            @foreach (var materiale in materialiCombo)
                                            {
                                                <option value="@materiale.CodiceMateriale" selected="@(voce.CodiceMateriale == materiale.CodiceMateriale)">
                                                    @materiale.CodiceMateriale
                                                </option>
                                            }
                                        </select>
                                    }
                                    else if (StatoRigaCorrente(voce) >= StatoRiga.Visualizzazione)
                                    {
                                        @voce.CodiceMateriale
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- U.M. MAT -->
                                <td class="td-materiali text-center">
                                    @if (!string.IsNullOrEmpty(voce.CodiceMateriale))
                                    {
                                        @if (StatoRigaCorrente(voce) == StatoRiga.Editing && campiEditabili.Contains("UM_Mat"))
                                        {
                                            <select @bind="voce.UM_Mat" class="campo-editabile combo-unita-misura">
                                                <option value="">-- Seleziona U.M. --</option>
                                                @foreach (var um in unitaMisuraMateriali)
                                                {
                                                    <option value="@um.UM">@um.UM - @um.Descrizione</option>
                                                }
                                            </select>
                                        }
                                        else if (StatoRigaCorrente(voce) >= StatoRiga.Visualizzazione)
                                        {
                                            @voce.UM_Mat
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- Q.TA' UM MATERIALE -->
                                <td class="td-materiali text-end">
                                    @if (!string.IsNullOrEmpty(voce.CodiceMateriale))
                                    {
                                        @if (StatoRigaCorrente(voce) == StatoRiga.Editing && campiEditabili.Contains("Qta_Mat"))
                                        {
                                            <input value="@voce.Qta_Mat"
                                                   @oninput="@((e) => OnCampoModificato(e, voce, "Qta_Mat"))"
                                                   class="campo-editabile" />
                                        }
                                        else if (StatoRigaCorrente(voce) >= StatoRiga.Visualizzazione)
                                        {
                                            @FormattaNumero(voce.Qta_Mat)
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- COSTO MATER. -->
                                <td class="td-materiali text-end">
                                    @if (!string.IsNullOrEmpty(voce.CodiceMateriale))
                                    {
                                        @if (StatoRigaCorrente(voce) == StatoRiga.Editing && campiEditabili.Contains("Costo_Mat"))
                                        {
                                            <input value="@voce.Costo_Mat"
                                                   @oninput="@((e) => OnCampoModificato(e, voce, "Costo_Mat"))"
                                                   class="campo-editabile" />
                                        }
                                        else if (StatoRigaCorrente(voce) >= StatoRiga.Visualizzazione)
                                        {
                                            @FormattaNumero(voce.Costo_Mat)
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- IMPORTO MATER. -->
                                <td class="td-materiali text-end">
                                    @if (!string.IsNullOrEmpty(voce.CodiceMateriale))
                                    {
                                        @FormattaDecimal((decimal)voce.ImportoMateriale)
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>

                                <!-- TOTALE VOCE -->
                                <td class="td-totale text-end fw-bold">
                                    @FormattaDecimal((decimal)voce.TotaleVoce) <!-- MODIFICA QUI -->
                                </td>                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
        <div class="azioni-griglia-compact">
            <button class="btn btn-success btn-small" @onclick="AggiungiNuovaVoceVuota">
                ➕ Aggiungi Voce
            </button>
        </div>
    </div>

    <!-- TOTALI -->
    <div class="sezione-totali">
        <h3>💰 Totali</h3>
        <div class="totali-compact">
            <div class="totale-riga-compact">
                <span>Totale Attività:</span>
                <span>€ @totaleAttivita.ToString("N2")</span>
            </div>
            <div class="totale-riga-compact">
                <span>Totale Materiali:</span>
                <span>€ @totaleMateriali.ToString("N2")</span>
            </div>
            <div class="totale-riga-compact imponibile-compact">
                <span>Imponibile:</span>
                <span>€ @imponibile.ToString("N2")</span>
            </div>
            <div class="totale-riga-compact">
                <span>IVA 22%:</span>
                <span>€ @iva.ToString("N2")</span>
            </div>
            <div class="totale-riga-compact totale-finale-compact">
                <strong>TOTALE:</strong>
                <strong>€ @totalePreventivo.ToString("N2")</strong>
            </div>
        </div>
    </div>

    <!-- FOOTER AZIONI -->
    <div class="page-footer-compact">
        <div class="footer-actions">
            <button class="btn btn-secondary btn-small" @onclick="Annulla">❌ Annulla</button>
        <button class="btn btn-outline-primary btn-small" @onclick="SalvaComeModello" 
                disabled="@(!vociPreventivo.Any())">
            📁 Salva come Modello
        </button>
            <button class="btn btn-success btn-small" @onclick="AggiornaPreventivo">💾 Salva Modifiche</button>
        </div>
    </div>
}

<!-- OVERLAY MESSAGGI DI STATO -->
@if (mostraErrore || mostraSuccesso)
{
    <div class="overlay-messaggi">
        <div class="messaggio-centrale @((mostraErrore ? "messaggio-errore" : "messaggio-successo"))">
            <div class="messaggio-icona">
                @if (mostraErrore)
                {
                    <span>❌</span>
                }
                @if (mostraSuccesso)
                {
                    <span>✅</span>
                }
            </div>
            <div class="messaggio-testo">
                <h4>@(mostraErrore ? "Errore" : "Successo")</h4>
                <p>@(mostraErrore? messaggioErrore : messaggioSuccesso)</p>
            </div>
            <button class="btn-close-overlay" @onclick="NascondiMessaggi">✕</button>
        </div>
    </div>
}



@code {

    //
    // VARIABILI
    //
    #region PARAMETRI E INIEZIONI
    [Parameter]
    public int PreventivoId { get; set; }
    private string _connectionString => Configuration.GetConnectionString("DefaultConnection") ?? "";
    #endregion

    #region VARIABILI E STATO COMPONENTE
    // Modelli dati
    private bool preventivoNonTrovato = true;
    private Preventivo preventivo = new();
    private List<Cliente> clienti = new();
    private List<Imbarcazione> imbarcazioni = new();
    private List<DettaglioPreventivo> vociPreventivo = new();
    private List<ModelloPreventivo> modelli = new();
    private List<Imbarcazione> imbarcazioniFiltrate = new();

    // Liste per combo
    private List<Attività> listaAttivita = new();
    private List<SubAttività> subAttivitaPerCombo = new();
    private List<Materiale> materialiCombo = new();
    private List<UnitaMisura> unitaMisuraAttivita = new();
    private List<UnitaMisura> unitaMisuraMateriali = new();

    // Selezione utente
    private int clienteSelezionatoId = 0;
    private int imbarcazioneSelezionataId = 0;
    private string modelloSelezionatoTitolo = string.Empty;
    private int? idRigaInEditing;

    // Calcoli e totali
    private decimal totaleAttivita = 0;
    private decimal totaleMateriali = 0;
    private decimal imponibile = 0;
    private decimal iva = 0;
    private decimal totalePreventivo = 0;
    private DateTime dataScadenza;

    // Stato UI
    private List<string> campiEditabili = new();

    // Messaggi di errore
    private string messaggioErrore = "";
    private string messaggioSuccesso = "";
    private bool mostraErrore = false;
    private bool mostraSuccesso = false;

    // Enumerazioni
    private enum StatoRiga 
    { 
        Vuota, 
        AttivitaSelezionata, 
        Visualizzazione, 
        Editing,
        AttesaMateriale // ✅ NUOVO STATO PER MIGLIORARE UI 
    }
    #endregion

    #region PROPRIETÀ CALCOLATE
    private Cliente? clienteSelezionato => clienti.FirstOrDefault(c => c.ClienteID == clienteSelezionatoId);
    private Imbarcazione? imbarcazioneSelezionata => imbarcazioniFiltrate.FirstOrDefault(i => i.ID_Imbarcazione == imbarcazioneSelezionataId);
    #endregion

    //
    // METODI
    //
    #region METODI LIFECYCLE  (Ciclo di Vita)
    protected override async Task OnInitializedAsync()
    {
        CaricaConfigurazioneStati(); 
        await CaricaDatiIniziali();
        await CaricaConfigurazioneEditing();
        await CaricaMaterialiPerCombo();
        await CaricaUnitaMisura();
        await CaricaPreventivoEsistente();
    }
    protected override async Task OnParametersSetAsync()
    {
        if (PreventivoId > 0)
        {
            preventivo.PreventivoId = PreventivoId;
            //Console.WriteLine($"📝 PreventivoId impostato da parametro: {PreventivoId}");
        }
        await base.OnParametersSetAsync();
    }
    #endregion

    #region INIZIALIZZAZIONE E CARICAMENTO DATI

    private async Task CaricaDatiIniziali()
    {
        try
        {
            //Console.WriteLine("🔄 Inizio caricamento dati iniziali...");

            // CARICA CLIENTI REALI DAL DATABASE
            clienti = await ClientiService.GetClientiPerPreventivo();
            //Console.WriteLine($"✅ Caricati {clienti.Count} clienti dal database");

            // CARICA MODELLI REALI DAL DATABASE
            modelli = await ModelliPreventiviService.GetModelliPreventivo();
            //Console.WriteLine($"✅ Caricati {modelli.Count} modelli preventivo dal database");

            // INIZIALIZZA IMBARCAZIONI VUOTE (SI CARICHERANNO QUANDO SI SELEZIONA CLIENTE)
            imbarcazioniFiltrate = new List<Imbarcazione>();
            //Console.WriteLine("✅ Liste imbarcazioni inizializzate");

            // INIZIALIZZA VOCI PREVENTIVO VUOTE
            vociPreventivo = new List<DettaglioPreventivo>();
            //Console.WriteLine("✅ Liste voci preventivo inizializzate");

            // RESETTA SELEZIONI
            clienteSelezionatoId = 0;
            imbarcazioneSelezionataId = 0;
            modelloSelezionatoTitolo = string.Empty;

            //Console.WriteLine("✅ Selezione reset completata");

            // RICALCOLA TOTALI (SARANNO ZERO)
            RicalcolaTotali();
            //Console.WriteLine("✅ Totali ricalcolati");

            //Console.WriteLine("🎉 Caricamento dati iniziali completato con successo");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ ERRORE CRITICO nel caricamento dati iniziali: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");

            // INIZIALIZZA LISTE VUOTE INVECE DI DATI MOCK
            clienti = new List<Cliente>();
            modelli = new List<ModelloPreventivo>();
            imbarcazioniFiltrate = new List<Imbarcazione>();
            vociPreventivo = new List<DettaglioPreventivo>();

            // RESETTA SELEZIONI
            clienteSelezionatoId = 0;
            imbarcazioneSelezionataId = 0;
            modelloSelezionatoTitolo = string.Empty;

            // TODO: IMPLEMENTARE MESSAGGIO ERRORE VISIVO PER L'UTENTE
            // Esempio: _alertService.ShowError("Impossibile caricare i dati. Riprovare più tardi.");

            Console.WriteLine("⚠️  Sistema inizializzato con liste vuote a causa dell'errore");
        }
        finally
        {
            // FORZA AGGIORNAMENTO UI
            StateHasChanged();
            //Console.WriteLine("🔄 UI aggiornata");
        }
    }
    private async Task CaricaConfigurazioneEditing()
    {
        try
        {
            // CARICA LA CONFIGURAZIONE DEI CAMPI EDITABILI
            var configurazione = await Task.Run(() =>
                Configuration.GetSection("CampiEditabiliPreventivo").Get<List<string>>()
            );

            campiEditabili = configurazione ?? new List<string>
            {
                "Qta_Voce",
                "Qta_Mat",
                "Costo_Mat"
            };

            //Console.WriteLine($"✅ Configurazione editing caricata: {campiEditabili.Count} campi");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Errore caricamento configurazione editing: {ex.Message}");
            campiEditabili = new List<string> { "Qta_Voce", "Qta_Mat", "Costo_Mat" };
        }
    }
    private async Task CaricaMaterialiPerCombo()
    {
        try
        {
            materialiCombo = await MaterialiService.GetMaterialiPerCombo();
            //Console.WriteLine($"✅ Caricati {materialiCombo.Count} materiali per combo");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Errore caricamento materiali: {ex.Message}");
            materialiCombo = new List<Materiale>();
        }
    }
    private async Task CaricaBarcheCliente(int clienteId)
    {
        if (clienteId == 0) return;

        StateHasChanged();

        try
        {
            // OTTIENI il CodiceCliente dal ClienteID selezionato
            var codiceCliente = await ClientiService.GetCodiceClienteById(clienteId);

            if (codiceCliente.HasValue)
            {
                // USA CodiceCliente per caricare le barche
                imbarcazioniFiltrate = await ImbarcazioniService.GetImbarcazioniByCliente(codiceCliente.Value);
            }
            else
            {
                imbarcazioniFiltrate = new List<Imbarcazione>();
                MostraErrore($"CodiceCliente non trovato per ClienteID: {clienteId}");

            }

            imbarcazioneSelezionataId = 0; // Resetta selezione barca
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Errore caricamento barche: {ex.Message}");
            imbarcazioniFiltrate = new List<Imbarcazione>();
        }
        finally
        {
            StateHasChanged();
        }
    }
    private async Task CaricaUnitaMisura()
    {
        try
        {
            unitaMisuraAttivita = await UnitaMisuraService.GetUnitaMisuraAttivita();
            unitaMisuraMateriali = await UnitaMisuraService.GetUnitaMisuraMateriali();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Errore caricamento unità di misura: {ex.Message}");
        }
    }
    private async Task CaricaPreventivoEsistente()
    {
        preventivoNonTrovato = true;
        try
        {
            preventivo = (await PreventiviService.GetPreventivoById(PreventivoId))!;
            if (preventivo != null)
            {
                vociPreventivo = await DettaglioPreventiviService.GetDettagliByPreventivoId(PreventivoId);
                dataScadenza = preventivo.DataScadenza;
                RicalcolaTotali();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Errore caricamento preventivo: {ex.Message}");
            MostraErrore("Errore nel caricamento del preventivo");
        }
        finally
        {
            preventivoNonTrovato = false;
            StateHasChanged();
        }
    }
    
    // Per evitare gli zero numerici in griglia 
    private string FormattaNumero(float valore)
    {
        return valore == 0 ? "" : valore.ToString("N1"); // NASCONDI ZERI
    }

    private string FormattaDecimal(decimal valore)
    {
        return valore == 0 ? "" : valore.ToString("N2"); // NASCONDI ZERI
    }
    #endregion

    #region GESTIONE SELEZIONI UTENTE

    // Gestione click sul combo Clienti per estrarre le sue barche
    private async Task OnClienteSelezionato(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int nuovoClienteId))
        {
            clienteSelezionatoId = nuovoClienteId;
            await CaricaBarcheCliente(nuovoClienteId);
            StateHasChanged();
        }
    }

    // Gestione click sul combo barche per visualizzare i dati della barca selezionate
    private void imbarcazioneSelezionataId_Changed(int nuovoValore)
    {
        imbarcazioneSelezionataId = nuovoValore;
        StateHasChanged(); // Forza l'aggiornamento dei dettagli
    }

    private async Task OnAttivitaSelezionata(ChangeEventArgs e, DettaglioPreventivo voce)
    {
        var nomeAttivitaSelezionata = e.Value?.ToString();
        if (string.IsNullOrEmpty(nomeAttivitaSelezionata))
            return;

        voce.DescrizioneAttivita = nomeAttivitaSelezionata;
        await CaricaVociPerAttivita(nomeAttivitaSelezionata);
        StateHasChanged();
    }

    private async Task OnVoceSelezionata(ChangeEventArgs e, DettaglioPreventivo voce)
    {
        if (int.TryParse(e.Value?.ToString(), out int subAttivitaId))
        {
            try
            {
                var subAttivitaCompleta = await SubAttivitaService.GetSubAttivitaByAttivita(
                    await TrovaCodiceAttivita(voce.DescrizioneAttivita)
                );

                var subAttivita = subAttivitaCompleta.FirstOrDefault(s => s.ID == subAttivitaId);
                if (subAttivita != null)
                {
                    // AUTO-POPOLA CON VALORI DEFAULT
                    voce.DescrizioneVoce = subAttivita.Voce;
                    voce.N_Operatori = subAttivita.N_Operatori;
                    voce.UnitaMisura = subAttivita.UnitaMisura;
                    voce.Qta_Voce = subAttivita.Qta_Voce;
                    voce.CodiceMateriale = subAttivita.CodiceMateriale;

                    if (string.IsNullOrEmpty(subAttivita.CodiceMateriale))
                    {
                        // ✅ SOLA ATTIVITÀ - VISUALIZZAZIONE NORMALE
                        voce.UM_Mat = string.Empty;
                        voce.Qta_Mat = 0;
                        voce.Costo_Mat = 0;
                    
                        // CALCOLA E CHIUDI
                        await CalcolaEChiudiVoce(voce);
                        idRigaInEditing = null; // Esci dall'editing
                    }
                    else
                    {
                        // ✅ CON MATERIALE - ENTRA IN STATO ATTESA
                        voce.UM_Mat = "KG"; // Default
                        voce.Qta_Mat = 0;
                        voce.Costo_Mat = 0;

                        // ✅ ENTRa IN MODALITÀ ATTESA MATERIALE
                        idRigaInEditing = voce.Id;

                        // CARICA DATI MATERIALE
                        await CaricaDettagliMateriale(voce, voce.CodiceMateriale);
                    
                        // CALCOLA SOLO ATTIVITÀ (MATERIALE = 0)
                        var voceCalcolata = await CalcoloService.CalcolaTotaleVoce(voce, (float)(imbarcazioneSelezionata?.Lunghezza ?? 0));
                        voce.ImportoVoce = voceCalcolata.ImportoVoce;
                        voce.ImportoMateriale = 0; // Ancora da definire
                        voce.TotaleVoce = voceCalcolata.ImportoVoce; // Solo attività

                        // ✅ AUTO-FOCUS SUL CAMPO QUANTITÀ
                        await SetFocusOnQtaMateriale(voce.Id);
                    }

                    RicalcolaTotali();
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Errore selezione voce: {ex.Message}");
            }
        }
    }
    private async Task CalcolaEChiudiVoce(DettaglioPreventivo voce)
    {
        var lunghezzaFloat = (float)(imbarcazioneSelezionata?.Lunghezza ?? 0);
        var voceCalcolata = await CalcoloService.CalcolaTotaleVoce(voce, lunghezzaFloat);

        voce.ImportoVoce = voceCalcolata.ImportoVoce;
        voce.ImportoMateriale = voceCalcolata.ImportoMateriale;
        voce.TotaleVoce = voceCalcolata.TotaleVoce;
    }
    private async Task SetFocusOnQtaMateriale(int voceId)
    {
        // Piccolo delay per permettere il rendering
        await Task.Delay(100);
    
        try
        {
            await JSRuntime.InvokeVoidAsync("setFocusOnElement", $"qta-mat-{voceId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"⚠️ Auto-focus non disponibile: {ex.Message}");
        }
    }
    private async Task OnMaterialeSelezionato(ChangeEventArgs e, DettaglioPreventivo voce)
    {
        var codiceMaterialeSelezionato = e.Value?.ToString();
        if (string.IsNullOrEmpty(codiceMaterialeSelezionato))
            return;

        try
        {
            var materiale = await MaterialiService.GetMaterialeByCodice(codiceMaterialeSelezionato);
            if (materiale != null)
            {
                voce.UM_Mat = materiale.UnitaMisura ?? "";
                voce.Costo_Mat = (float)(materiale.PrezzoUnitario ?? 0);

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Errore caricamento materiale {codiceMaterialeSelezionato}: {ex.Message}");
        }
    }
    private async Task ApplicaModello()
    {
        if (string.IsNullOrEmpty(modelloSelezionatoTitolo))
        {
            Console.WriteLine("⚠️  Nessun modello selezionato");
            return;
        }

        try
        {
            //Console.WriteLine($"🔄 Applicazione modello: {modelloSelezionatoTitolo}");

            // CARICA LE VOCI DEL MODELLO PER TITOLO
            var vociModello = await ModelliPreventiviService.GetVociModelloByTitolo(modelloSelezionatoTitolo);

            if (!vociModello.Any())
            {
                Console.WriteLine("⚠️  Il modello selezionato non contiene voci");
                return;
            }

            var nuoveVoci = ModelliPreventiviService.ConvertiModelloInPreventivo(vociModello, 0);
            vociPreventivo.Clear();
            vociPreventivo.AddRange(nuoveVoci);

            RicalcolaTotali();
            StateHasChanged();

            //Console.WriteLine($"🎉 Modello applicato con successo! {vociPreventivo.Count} voci caricate");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ ERRORE: {ex.Message}");
        }
    }
    #endregion

    #region GESTIONE VOCI PREVENTIVO
    private async Task AggiungiNuovaVoceVuota()
    {
        if (clienteSelezionatoId == 0 || imbarcazioneSelezionataId == 0)
        {
            MostraErrore("Seleziona prima cliente e barca");
            return;
        }

        try
        {
            // CARICA LE ATTIVITÀ SE NON ANCORA CARICATE
            if (!listaAttivita.Any())
            {
                listaAttivita = await AttivitaService.GetAttivita();
            }

            // CREA NUOVA VOCE VUOTA
            var nuovaVoce = new DettaglioPreventivo
            {
                Id = vociPreventivo.Count > 0 ? vociPreventivo.Max(v => v.Id) + 1 : 1,
                DescrizioneAttivita = "", // VUOTO
                DescrizioneVoce = "",    // VUOTO
                N_Operatori = 1,         // VALORE DEFAULT
                UnitaMisura = "",        // VUOTO
                Qta_Voce = 0,            // ZERO
                ImportoVoce = 0,
                ImportoMateriale = 0,
                TotaleVoce = 0
            };

            vociPreventivo.Add(nuovaVoce);
            idRigaInEditing = nuovaVoce.Id;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Errore aggiunta voce: {ex.Message}");
        }
    }

    // Da controllare Codice
    private async Task AggiungiVoceAttivita(DettaglioPreventivo voceEsistente)
    {
        // 1. TROVA CODICE ATTIVITÀ
        var codiceAttivita = await TrovaCodiceAttivita(voceEsistente.DescrizioneAttivita);
        if (codiceAttivita == 0) return;

        // 2. CARICA COMBO (USA STESSA VARIABILE)
        subAttivitaPerCombo = await SubAttivitaService.CaricaComboVociPerAttivita(codiceAttivita);

        // 3. INSERISCI RIGA (RESTO CODICE INVARIATO)
        var indice = vociPreventivo.IndexOf(voceEsistente);
        var nuovaVoce = new DettaglioPreventivo
        {
            Id = -1,
            DescrizioneAttivita = voceEsistente.DescrizioneAttivita
            // ... altri campi
        };

        vociPreventivo.Insert(indice + 1, nuovaVoce);
        idRigaInEditing = nuovaVoce.Id;
        StateHasChanged();
    }

    private void EliminaVoce(DettaglioPreventivo voce)
    {
        vociPreventivo.Remove(voce);
        RicalcolaTotali();
        StateHasChanged();
    }

    private async Task<int> TrovaCodiceAttivita(string nomeAttivita)
    {
        if (!listaAttivita.Any())
        {
            listaAttivita = await AttivitaService.GetAttivita();
        }

        var attivita = listaAttivita.FirstOrDefault(a => a.NomeAttivita == nomeAttivita);
        return attivita?.CodiceAttivita ?? 0;
    }
    private async Task CaricaVociPerAttivita(string nomeAttivita)
    {
        try
        {
            // CARICA LISTA ATTIVITÀ SE NON ANCORA CARICATA
            if (!listaAttivita.Any())
            {
                listaAttivita = await AttivitaService.GetAttivita();
            }

            // TROVA CODICE ATTIVITÀ DAL NOME
            var attivita = listaAttivita.FirstOrDefault(a => a.NomeAttivita == nomeAttivita);
            if (attivita != null)
            {
                subAttivitaPerCombo = await SubAttivitaService.CaricaComboVociPerAttivita(attivita.CodiceAttivita);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Errore caricamento voci: {ex.Message}");
            subAttivitaPerCombo = new List<SubAttività>();
        }
    }

    private bool IsVoceGiaPresente(string nomeAttivita, string nomeVoce)
    {
        return vociPreventivo.Any(v =>
            v.DescrizioneAttivita == nomeAttivita &&
            v.DescrizioneVoce == nomeVoce &&
            v.Id != idRigaInEditing // esclude la riga corrente in editing
        );
    }
    #endregion

    #region GESTIONE STATO RIGHE E EDITING
    private StatoRiga StatoRigaCorrente(DettaglioPreventivo voce)
    {
        if (string.IsNullOrEmpty(voce.DescrizioneAttivita))
            return StatoRiga.Vuota;
        else if (string.IsNullOrEmpty(voce.DescrizioneVoce))
            return StatoRiga.AttivitaSelezionata;
        else if (idRigaInEditing == voce.Id)
            return StatoRiga.Editing;
        else
            return StatoRiga.Visualizzazione;
    }
    private void AttivaEditing(DettaglioPreventivo voce)
    {
        idRigaInEditing = voce.Id;
        StateHasChanged();
    }
    private async Task ConfermaModifiche(DettaglioPreventivo voce)
    {
        // RICALCOLA PRIMA DI CHIUDERE
        var lunghezzaFloat = (float)(imbarcazioneSelezionata?.Lunghezza ?? 0);
        var voceCalcolata = await CalcoloService.CalcolaTotaleVoce(voce, lunghezzaFloat);

        voce.ImportoVoce = voceCalcolata.ImportoVoce;
        voce.ImportoMateriale = voceCalcolata.ImportoMateriale;
        voce.TotaleVoce = voceCalcolata.TotaleVoce;

        idRigaInEditing = null;
        RicalcolaTotali();
        StateHasChanged();
    }
    private void AnnullaModifiche(DettaglioPreventivo voce)
    {
        idRigaInEditing = null;
        StateHasChanged();
    }
    private void AnnullaInserimento(DettaglioPreventivo voce)
    {
        vociPreventivo.Remove(voce);
        idRigaInEditing = null;
        StateHasChanged();
    }
    #endregion

    #region CALCOLI E TOTALI
    private void RicalcolaTotali()
    {
        var (totaleAtt, totaleMat, impon, ivaCalc, totaleGen) =
            CalcoloService.CalcolaTotalePreventivo(vociPreventivo);

        totaleAttivita = totaleAtt;
        totaleMateriali = totaleMat;
        imponibile = impon;
        iva = ivaCalc;
        totalePreventivo = totaleGen;

        StateHasChanged();
    }
    #endregion

    #region GESTIONE MODIFICHE IN TEMPO REALE

    private async Task OnCampoModificato(ChangeEventArgs e, DettaglioPreventivo voce, string tipoCampo)
    {
        var valore = e.Value?.ToString();

        if (!string.IsNullOrEmpty(valore))
        {
            try
            {
                switch (tipoCampo)
                {
                    case "N_Operatori":
                        if (int.TryParse(valore, out int nOperai))
                            voce.N_Operatori = nOperai;
                        break;
                    case "Qta_Voce":
                        if (double.TryParse(valore, out double qtaVoce))
                            voce.Qta_Voce = (float)qtaVoce;
                        break;
                    case "Qta_Mat":
                        if (double.TryParse(valore, out double qtaMat))
                            voce.Qta_Mat = (float)qtaMat;
                        break;
                    case "Costo_Mat":
                        if (decimal.TryParse(valore, NumberStyles.Any, CultureInfo.InvariantCulture, out decimal costoMat))
                            voce.Costo_Mat = (float)costoMat;
                        break;
                    // I campi UnitaMisura, UM_Mat e CodiceMateriale sono ora gestiti da @bind
                }

                await RicalcolaVoceInTempoReale(voce);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Errore modifica campo {tipoCampo}: {ex.Message}");
            }
        }
    }
    private async Task CaricaDettagliMateriale(DettaglioPreventivo voce, string codiceMateriale)
    {
        try
        {
            var materiale = await MaterialiService.GetMaterialeByCodice(codiceMateriale);
            if (materiale != null)
            {
                voce.UM_Mat = materiale.UnitaMisura ?? "";
                voce.Costo_Mat = (float)(materiale.PrezzoUnitario ?? 0); // 🔥 CAST AGGIUNTO
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Errore caricamento materiale: {ex.Message}");
        }
    }
    private async Task OnMaterialeCambiato(ChangeEventArgs e, DettaglioPreventivo voce)
    {
        var codiceMateriale = e.Value?.ToString();
        if (!string.IsNullOrEmpty(codiceMateriale))
        {
            await OnMaterialeSelezionato(e, voce);
            // Dopo aver cambiato materiale, ricalcola
            await RicalcolaVoceInTempoReale(voce);
        }
    }
    private async Task RicalcolaVoceInTempoReale(DettaglioPreventivo voce)
    {
        try
        {
            // Piccolo delay per permettere al binding di aggiornare il modello
            await Task.Delay(50);

            var lunghezzaFloat = (float)(imbarcazioneSelezionata?.Lunghezza ?? 0);
            var voceCalcolata = await CalcoloService.CalcolaTotaleVoce(voce, lunghezzaFloat);

            // Aggiorna la voce con i nuovi calcoli
            voce.ImportoVoce = voceCalcolata.ImportoVoce;
            voce.ImportoMateriale = voceCalcolata.ImportoMateriale;
            voce.TotaleVoce = voceCalcolata.TotaleVoce;

            // Ricalcola i totali del preventivo
            RicalcolaTotali();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Errore ricalcolo automatico: {ex.Message}");
        }
    }

    #endregion

    #region AZIONI PREVENTIVO

    private async Task<bool> ValidazionePreventivo()
    {

        // VERIFICA VOCI PREVENTIVO
        if (!vociPreventivo.Any())
        {
            MostraErrore("Inserisci almeno una voce nel preventivo");
            return false;
        }

        // VERIFICA DATE
        if (preventivo.DataCreazione > dataScadenza)
        {
            MostraErrore("La data di scadenza non può essere precedente alla data di creazione");
            return false;
        }

        // VERIFICA DESCRIZIONE
        if (string.IsNullOrWhiteSpace(preventivo.Descrizione))
        {
            MostraErrore("Inserisci una descrizione per il preventivo");
            return false;
        }

        // VERIFICA OGNI VOCE
        var voceIndex = 1;
        foreach (var voce in vociPreventivo)
        {
            // VERIFICA CAMPI OBBLIGATORI
            if (string.IsNullOrWhiteSpace(voce.DescrizioneAttivita))
            {
                MostraErrore($"Riga #{voce.Id}: Descrizione attività mancante");
                                return false;
            }

            if (string.IsNullOrWhiteSpace(voce.DescrizioneVoce))
            {
                MostraErrore($"Riga #{voce.Id}: Descrizione voce mancante");
                return false;
            }

            // VERIFICA NUMERI POSITIVI
            if (voce.N_Operatori <= 0)
            {
                MostraErrore($"Riga #{voce.Id}: Numero operatori deve essere maggiore di 0");
                return false;
            }

            if (voce.Qta_Voce < 0)
            {
                MostraErrore($"Riga #{voce.Id}: Quantità voce non può essere negativa");
                return false;
            }

            if (voce.Qta_Mat < 0)
            {
                MostraErrore($"Riga #{voce.Id}: Quantità materiale non può essere negativa");
                return false;
            }

            if (voce.Costo_Mat < 0)
            {
                MostraErrore($"Riga #{voce.Id}: Costo materiale non può essere negativo");
                return false;
            }

            // VERIFICA UNITA DI MISURA ATTIVITÀ
            if (string.IsNullOrWhiteSpace(voce.UnitaMisura))
            {
                MostraErrore($"Riga #{voce.Id}: Unità di misura attività mancante");
                return false;
            }

            // VERIFICA COERENZA MATERIALI
            bool hasCodiceMateriale = !string.IsNullOrWhiteSpace(voce.CodiceMateriale);
            bool hasUmMat = !string.IsNullOrWhiteSpace(voce.UM_Mat);

            if (hasCodiceMateriale && !hasUmMat)
            {
                MostraErrore($"Riga #{voce.Id}: Unità di misura materiale mancante per il materiale selezionato");
                return false;
            }

            if (!hasCodiceMateriale && hasUmMat)
            {
                MostraErrore($"Riga #{voce.Id}: Codice materiale mancante per l'unità di misura selezionata");
                return false;
            }

            // VERIFICA MATERIALE SE CODICE PRESENTE
            if (hasCodiceMateriale)
            {
                if (voce.Costo_Mat == 0)
                {
                    MostraErrore($"Riga #{voce.Id}: Costo materiale zero per materiale selezionato");
                    return false;
                }

                // VERIFICA ESISTENZA MATERIALE NEL DATABASE
                try
                {
                    var materiale = await MaterialiService.GetMaterialeByCodice(voce.CodiceMateriale.Trim());
                    if (materiale == null)
                    {
                        MostraErrore($"Riga #{voce.Id}: Codice materiale '{voce.CodiceMateriale}' non trovato nel database");
                        return false;
                    }
                }
                catch (Exception ex)
                {
                    MostraErrore($"Riga #{voce.Id}: Errore verifica materiale - {ex.Message}");
                    return false;
                }
            }

            // VERIFICA CALCOLI
            if (voce.ImportoVoce < 0 || voce.ImportoMateriale < 0 || voce.TotaleVoce < 0)
            {
                MostraErrore($"Riga #{voce.Id}: Importi calcolati non validi");
                return false;
            }

            voceIndex++;
        }

        // VERIFICA TOTALI
        if (totalePreventivo <= 0)
        {
            MostraErrore("Il totale del preventivo deve essere maggiore di 0");
            return false;
        }

        return true;
    }

    private async Task<bool> SalvaDettagliPreventivo(SqlConnection connection, SqlTransaction transaction, int preventivoId)
    {
        var voceId = 1;
        foreach (var voce in vociPreventivo)
        {
            var success = await SalvaSingoloDettaglio(connection, transaction, preventivoId, voce, voceId);
            if (!success) return false;
            voceId++;
        }
        return true;
    }

    private async Task<bool> SalvaSingoloDettaglio(SqlConnection connection, SqlTransaction transaction, int preventivoId, DettaglioPreventivo voce, int voceId)
    {
        var query = @"INSERT INTO DettaglioPreventivi (
                    PreventivoId, VoceId, DescrizioneAttivita, DescrizioneVoce,
                    N_Operatori, UnitaMisura, Qta_Voce, ImportoVoce,
                    CodiceMateriale, UM_Mat, Costo_Mat, Qta_Mat, ImportoMateriale, TotaleVoce
                 ) VALUES (
                    @PreventivoId, @VoceId, @DescrizioneAttivita, @DescrizioneVoce,
                    @N_Operatori, @UnitaMisura, @Qta_Voce, @ImportoVoce,
                    @CodiceMateriale, @UM_Mat, @Costo_Mat, @Qta_Mat, @ImportoMateriale, @TotaleVoce
                 )";

        using var command = new SqlCommand(query, connection, transaction);

        command.Parameters.AddWithValue("@PreventivoId", preventivoId);
        command.Parameters.AddWithValue("@VoceId", voceId);
        command.Parameters.AddWithValue("@DescrizioneAttivita", voce.DescrizioneAttivita);
        command.Parameters.AddWithValue("@DescrizioneVoce", voce.DescrizioneVoce);
        command.Parameters.AddWithValue("@N_Operatori", voce.N_Operatori);
        command.Parameters.AddWithValue("@UnitaMisura", (object)voce.UnitaMisura ?? DBNull.Value);
        command.Parameters.AddWithValue("@Qta_Voce", voce.Qta_Voce);
        command.Parameters.AddWithValue("@ImportoVoce", voce.ImportoVoce);
        command.Parameters.AddWithValue("@CodiceMateriale", (object)voce.CodiceMateriale ?? DBNull.Value);
        command.Parameters.AddWithValue("@UM_Mat", (object)voce.UM_Mat ?? DBNull.Value);
        command.Parameters.AddWithValue("@Costo_Mat", voce.Costo_Mat);
        command.Parameters.AddWithValue("@Qta_Mat", voce.Qta_Mat);
        command.Parameters.AddWithValue("@ImportoMateriale", voce.ImportoMateriale);
        command.Parameters.AddWithValue("@TotaleVoce", voce.TotaleVoce);

        var result = await command.ExecuteNonQueryAsync();
        return result > 0;
    }

    private async Task AggiornaPreventivo()
    {
        if (!await ValidazionePreventivo())
            return;

        try
        {
            if (await JSRuntime.InvokeAsync<bool>("confirm", "Confermi il salvataggio delle modifiche al preventivo?"))
        {

                // Prepara dati preventivo
                preventivo.DataScadenza = dataScadenza;
                preventivo.ImportoTotale = totalePreventivo;

                // Aggiorna in transaction
                var success = await AggiornaPreventivoCompleto();

                if (success)
                {
                    MostraSuccesso("✅ Preventivo aggiornato con successo!");
                    Navigation.NavigateTo("/amministrazione");
                }
                else
                {
                    MostraErrore("❌ Errore nell'aggiornamento del preventivo");
                }

            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ ERRORE CRITICO: {ex.Message}");
            MostraErrore($"Errore durante l'aggiornamento: {ex.Message}");
        }
    }

    private async Task<bool> AggiornaPreventivoCompleto()
    {
        using var connection = new SqlConnection(_connectionString);
        await connection.OpenAsync();

        using var transaction = (SqlTransaction)await connection.BeginTransactionAsync();

        try
        {
        // 1. AGGIORNA PREVENTIVO (INTESTAZIONE)
        var preventivoAggiornato = await AggiornaPreventivoIntestazione(connection, transaction);
        if (!preventivoAggiornato)
        {
            await transaction.RollbackAsync();
            return false;
        }

        // 2. ELIMINA E RICREA DETTAGLI PREVENTIVO
        var dettagliEliminati = await EliminaDettagliPreventivo(connection, transaction, preventivo.PreventivoId);
        if (!dettagliEliminati)
        {
            await transaction.RollbackAsync();
            return false;
        }

        var dettagliSalvati = await SalvaDettagliPreventivo(connection, transaction, preventivo.PreventivoId);
        if (!dettagliSalvati)
        {
            await transaction.RollbackAsync();
            return false;
        }

        // 3. COMMIT PRIMA DELLE OPERAZIONI LENTE
        await transaction.CommitAsync();

        // 2. GENERA SCHEDE E INVIA EMAIL DOPO IL COMMIT
        if (preventivo.Stato == "IN LAVORAZIONE")
        {
            var schedeGenerate = await SchedaLavorazioneService.GeneraSchedeLavorazioneDaPreventivo(preventivo.PreventivoId);
            if (schedeGenerate)
            {
                await EmailService.InviaNotificaInizioLavori(preventivo.PreventivoId);
            }
        }
        return true;
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync();
            Console.WriteLine($"❌ ERRORE Transaction: {ex.Message}");
            return false;
        }
    }

    private async Task<bool> AggiornaPreventivoIntestazione(SqlConnection connection, SqlTransaction transaction)
    {
        var query = @"UPDATE Preventivi SET
                    DataCreazione = @DataCreazione,
                    DataScadenza = @DataScadenza,
                    Descrizione = @Descrizione,
                    ImportoTotale = @ImportoTotale,
                    Stato = @Stato,
                    NomePreventivo = @NomePreventivo
                 WHERE PreventivoId = @PreventivoId";

        using var command = new SqlCommand(query, connection, transaction);

        command.Parameters.AddWithValue("@PreventivoId", preventivo.PreventivoId);
        command.Parameters.AddWithValue("@DataCreazione", preventivo.DataCreazione);
        command.Parameters.AddWithValue("@DataScadenza", dataScadenza);
        command.Parameters.AddWithValue("@Descrizione", (object)preventivo.Descrizione ?? DBNull.Value);
        command.Parameters.AddWithValue("@ImportoTotale", preventivo.ImportoTotale);
        command.Parameters.AddWithValue("@Stato", preventivo.Stato);
        command.Parameters.AddWithValue("@NomePreventivo", (object)preventivo.NomePreventivo ?? DBNull.Value);

        var result = await command.ExecuteNonQueryAsync();
        return result > 0;
    }

    private async Task<bool> EliminaDettagliPreventivo(SqlConnection connection, SqlTransaction transaction, int preventivoId)
    {
        var query = "DELETE FROM DettaglioPreventivi WHERE PreventivoId = @PreventivoId";
    
        using var command = new SqlCommand(query, connection, transaction);
        command.Parameters.AddWithValue("@PreventivoId", preventivoId);
    
        var result = await command.ExecuteNonQueryAsync();
        return true; // Ritorna sempre true, anche se non ci sono dettagli da eliminare
    }

    private async Task SalvaComeModello()
    {
        if (!vociPreventivo.Any())
        {
            MostraErrore("Impossibile salvare un modello vuoto");
            return;
        }

        // 1. Chiedi il nome del modello
        var nomeModello = await JSRuntime.InvokeAsync<string>("prompt", 
            "Inserisci un nome per questo modello:", 
            $"Modello {DateTime.Today:dd/MM/yyyy}");
    
        if (string.IsNullOrWhiteSpace(nomeModello)) 
        {
            await JSRuntime.InvokeVoidAsync("alert", "Nome modello obbligatorio!");
            return;
        }
    
        // 2. Verifica se il modello esiste già
        bool modelloEsiste = await ModelliPreventiviService.ModelloEsiste(nomeModello);
        if (modelloEsiste)
        {
            var confermaSovrascrivi = await JSRuntime.InvokeAsync<bool>("confirm", 
                $"Il modello '{nomeModello}' esiste già. Vuoi sovrascriverlo?");
        
            if (!confermaSovrascrivi) return;
        }
    
        // 3. Converti le voci preventivo in voci modello
        var vociModello = ConvertiPreventivoInModello(nomeModello);
    
        // 4. Salva il modello
        try 
        {
            int modelloId = await ModelliPreventiviService.CreaModelloPreventivo(nomeModello, vociModello);
            MostraSuccesso($"✅ Modello '{nomeModello}' salvato con ID: {modelloId}");
        }
        catch (Exception ex)
        {
            MostraErrore($"❌ Errore nel salvataggio: {ex.Message}");
        }
    }

    // METODO PER CONVERTIRE PREVENTIVO → MODELLO
    private List<ModelloPreventivo> ConvertiPreventivoInModello(string nomeModello)
{
    var vociModello = new List<ModelloPreventivo>();
    var voceId = 1;

    foreach (var dettaglio in vociPreventivo)
    {
        var voceModello = new ModelloPreventivo
        {
            TitoloPreventivo = nomeModello,
            VoceId = voceId++,
            DescrizioneAttivita = dettaglio.DescrizioneAttivita,
            DescrizioneVoce = dettaglio.DescrizioneVoce,
            N_Operatori = dettaglio.N_Operatori,
            UnitaMisura = dettaglio.UnitaMisura,
            Qta_Voce = (double)dettaglio.Qta_Voce,
            CodiceMateriale = dettaglio.CodiceMateriale ?? string.Empty,
            UM_Mat = dettaglio.UM_Mat ?? string.Empty,

            // ✅ ATTIVITÀ - SEMPRE SALVA GLI IMPORTI
            ImportoVoce = (decimal)dettaglio.ImportoVoce,
            TotaleVoce = (decimal)dettaglio.TotaleVoce,

            // ✅ INIZIALIZZA I CAMPI MATERIALE A ZERO
            Qta_Mat = 0,
            Costo_Mat = 0,
            ImportoMateriale = 0
        };

        // ✅ GESTIONE MATERIALI - STRATEGIA DIFFERENZIATA
        if (!string.IsNullOrEmpty(dettaglio.CodiceMateriale))
        {
            bool isMaterialeVariabile = !string.IsNullOrEmpty(dettaglio.UM_Mat) && 
                                      (dettaglio.UM_Mat.Contains("/ML") || dettaglio.UM_Mat.Contains("/MQ"));

            if (isMaterialeVariabile)
            {
                // ❌ MATERIALE VARIABILE (KG/ML, LT/ML) - NON SALVARE QUANTITÀ E COSTI
                // Mantieni tutto a zero (già inizializzato sopra)
                
                // ⚠️ AZZERA IL TOTALE VOCE PER MATERIALI VARIABILI
                voceModello.TotaleVoce = voceModello.ImportoVoce; // Solo attività
            }
            else
            {
                // ✅ MATERIALE FISSO (KG, LT, NUM) - SALVA TUTTO
                // ✅ USA GetValueOrDefault() PER EVITARE ERRORI DI CONVERSIONE
                voceModello.Qta_Mat = (double)dettaglio.Qta_Mat;
                voceModello.Costo_Mat = (decimal)(dettaglio.Costo_Mat); // float → decimal
                voceModello.ImportoMateriale = (decimal)(dettaglio.ImportoMateriale); // float → decimal
                // TotaleVoce già impostato sopra include attività + materiale
            }
        }
        // ✅ PER SOLE ATTIVITÀ (NESSUN MATERIALE) - MANTIENI TOTALE VOCE (già fatto sopra)

        vociModello.Add(voceModello);
    }

    return vociModello;
}

    private void MostraErrore(string messaggio)
    {
        messaggioErrore = messaggio;
        mostraErrore = true;
        mostraSuccesso = false;
        StateHasChanged();

        // Auto-rimuovi dopo 5 secondi
        _ = Task.Delay(5000).ContinueWith(_ =>
        {
            mostraErrore = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private void MostraSuccesso(string messaggio)
    {
        messaggioSuccesso = messaggio;
        mostraSuccesso = true;
        mostraErrore = false;
        StateHasChanged();

        // Auto-rimuovi dopo 3 secondi
        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            mostraSuccesso = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private void NascondiMessaggi()
    {
        mostraErrore = false;
        mostraSuccesso = false;
        StateHasChanged();
    }

    private async Task Annulla()
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Sei sicuro di voler annullare le modifiche? I dati non salvati andranno persi."))
        {
            Navigation.NavigateTo("/amministrazione");
        }
    }
    #endregion

    #region CONFIGURAZIONE STATI
    private StatiPreventivoConfig _statiConfig = new();

    private void CaricaConfigurazioneStati()
    {
        try
        {
            _statiConfig = Configuration.GetSection("StatiPreventivo").Get<StatiPreventivoConfig>() ?? new StatiPreventivoConfig();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Errore caricamento configurazione stati: {ex.Message}");
            _statiConfig = new StatiPreventivoConfig();
        }
    }
    #endregion
}

